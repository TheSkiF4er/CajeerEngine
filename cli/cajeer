#!/usr/bin/env php
<?php
require_once __DIR__ . '/../engine/bootstrap.php';

$cmd = $argv[1] ?? 'help';

switch ($cmd) {
    case 'diagnose':
        echo "CajeerEngine diagnose: OK\n";
        echo "PHP: " . PHP_VERSION . "\n";
        echo "Version: " . trim(file_get_contents(ROOT_PATH . '/system/version.txt')) . "\n";
        exit(0);

    case 'cache:clear':
        echo "Cache clear (stub)\n";
        exit(0);

      case 'db:install':
    $db = require ROOT_PATH . '/system/db.php';
    $pdo = \Database\DB::connect($db);
    $sql = file_get_contents(ROOT_PATH . '/system/schema.sql');
    $pdo->exec($sql);
    echo "DB schema installed.\n";
    exit(0);

  case 'seed:demo':
    $db = require ROOT_PATH . '/system/db.php';
    $pdo = \Database\DB::connect($db);
    $sql = file_get_contents(ROOT_PATH . '/system/seed_demo.sql');
    $pdo->exec($sql);
    echo "Demo data inserted.\n";
    exit(0);


  case 'plugin:list':
    $pm = new \Plugins\PluginManager(ROOT_PATH . '/plugins', ROOT_PATH . '/system/plugins.php', trim(file_get_contents(ROOT_PATH . '/system/version.txt')));
    $list = $pm->list();
    foreach ($list as $p) {
      echo ($p['enabled'] ? '[x] ' : '[ ] ') . $p['id'] . ' ' . $p['version'] . ' — ' . $p['name'] . "\n";
    }
    exit(0);

  case 'plugin:enable':
    $id = $argv[2] ?? '';
    if (!$id) { echo "Usage: php cli/cajeer plugin:enable <id>\n"; exit(2); }
    $pm = new \Plugins\PluginManager(ROOT_PATH . '/plugins', ROOT_PATH . '/system/plugins.php', trim(file_get_contents(ROOT_PATH . '/system/version.txt')));
    $pm->enable($id);
    echo "Enabled: $id\n";
    exit(0);

  case 'plugin:disable':
    $id = $argv[2] ?? '';
    if (!$id) { echo "Usage: php cli/cajeer plugin:disable <id>\n"; exit(2); }
    $pm = new \Plugins\PluginManager(ROOT_PATH . '/plugins', ROOT_PATH . '/system/plugins.php', trim(file_get_contents(ROOT_PATH . '/system/version.txt')));
    $pm->disable($id);
    echo "Disabled: $id\n";
    exit(0);

  case 'plugin:install':
    $id = $argv[2] ?? '';
    if (!$id) { echo "Usage: php cli/cajeer plugin:install <id>\n"; exit(2); }
    $pm = new \Plugins\PluginManager(ROOT_PATH . '/plugins', ROOT_PATH . '/system/plugins.php', trim(file_get_contents(ROOT_PATH . '/system/version.txt')));
    $pm->install($id);
    echo "Installed: $id\n";
    exit(0);

  case 'plugin:uninstall':
    $id = $argv[2] ?? '';
    if (!$id) { echo "Usage: php cli/cajeer plugin:uninstall <id>\n"; exit(2); }
    $pm = new \Plugins\PluginManager(ROOT_PATH . '/plugins', ROOT_PATH . '/system/plugins.php', trim(file_get_contents(ROOT_PATH . '/system/version.txt')));
    $pm->uninstall($id);
    echo "Uninstalled: $id\n";
    exit(0);



  case 'migrate:dle:check':
    \Core\Config::load();
    $cfg = require ROOT_PATH . '/system/dle.php';
    $tpl = $argv[2] ?? null; // path to DLE templates
    $m = new \Migration\Dle\DleMigrator();
    $report = $m->check($cfg, $tpl);
    $file = $report->save(ROOT_PATH . '/storage/migrations');
    echo "Report: $file\n";
    echo $report->ok() ? "OK\n" : "HAS ERRORS\n";
    exit($report->ok() ? 0 : 1);

  case 'migrate:dle:db':
    \Core\Config::load();
    $cfg = require ROOT_PATH . '/system/dle.php';
    $m = new \Migration\Dle\DleMigrator();
    $report = new \Migration\Report();
    try { $m->importDb($cfg, $report); } catch (\Throwable $e) { $report->error('Импорт БД упал', ['error'=>$e->getMessage()]); }
    $file = $report->save(ROOT_PATH . '/storage/migrations');
    echo "Report: $file\n";
    exit($report->ok() ? 0 : 1);

  case 'migrate:dle:templates':
    $src = $argv[2] ?? '';
    $dst = $argv[3] ?? (ROOT_PATH . '/templates/dle-converted');
    if (!$src) { echo "Usage: php cli/cajeer migrate:dle:templates <dle_templates_dir> [dst_dir]\n"; exit(2); }
    $report = new \Migration\Report();
    (new \Migration\Dle\DleMigrator())->convertTemplates($src, $dst, $report);
    $file = $report->save(ROOT_PATH . '/storage/migrations');
    echo "Converted -> $dst\n";
    echo "Report: $file\n";
    exit($report->ok() ? 0 : 1);

  case 'migrate:dle:run':
    \Core\Config::load();
    $cfg = require ROOT_PATH . '/system/dle.php';
    $srcTpl = $argv[2] ?? '';
    $dstTpl = $argv[3] ?? (ROOT_PATH . '/templates/dle-converted');
    if (!$srcTpl) { echo "Usage: php cli/cajeer migrate:dle:run <dle_templates_dir> [dst_dir]\n"; exit(2); }

    $m = new \Migration\Dle\DleMigrator();
    $report = $m->check($cfg, $srcTpl);
    if (!$report->ok()) {
      $file = $report->save(ROOT_PATH . '/storage/migrations');
      echo "Report: $file\n";
      echo "Compatibility check failed. Fix warnings/errors and retry.\n";
      exit(1);
    }
    try { $m->importDb($cfg, $report); } catch (\Throwable $e) { $report->error('Импорт БД упал', ['error'=>$e->getMessage()]); }
    $m->convertTemplates($srcTpl, $dstTpl, $report);

    $file = $report->save(ROOT_PATH . '/storage/migrations');
    echo "Report: $file\n";
    exit($report->ok() ? 0 : 1);

  default:
        echo "CajeerEngine CLI\n";
        echo "Commands:\n";
        echo "  diagnose\n";
        echo "  cache:clear\n";
        exit(0);
}
