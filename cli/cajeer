#!/usr/bin/env php
<?php
require_once __DIR__ . '/../engine/bootstrap.php';

$cmd = $argv[1] ?? 'help';

switch ($cmd) {
    case 'diagnose':
        echo "CajeerEngine diagnose: OK\n";
        echo "PHP: " . PHP_VERSION . "\n";
        echo "Version: " . trim(file_get_contents(ROOT_PATH . '/system/version.txt')) . "\n";
        exit(0);

    case 'cache:clear':
        echo "Cache clear (stub)\n";
        exit(0);

      case 'db:install':
    $db = require ROOT_PATH . '/system/db.php';
    $pdo = \Database\DB::connect($db);
    $sql = file_get_contents(ROOT_PATH . '/system/schema.sql');
    $pdo->exec($sql);
    echo "DB schema installed.\n";
    exit(0);

  case 'seed:demo':
    $db = require ROOT_PATH . '/system/db.php';
    $pdo = \Database\DB::connect($db);
    $sql = file_get_contents(ROOT_PATH . '/system/seed_demo.sql');
    $pdo->exec($sql);
    echo "Demo data inserted.\n";
    exit(0);


  case 'plugin:list':
    $pm = new \Plugins\PluginManager(ROOT_PATH . '/plugins', ROOT_PATH . '/system/plugins.php', trim(file_get_contents(ROOT_PATH . '/system/version.txt')));
    $list = $pm->list();
    foreach ($list as $p) {
      echo ($p['enabled'] ? '[x] ' : '[ ] ') . $p['id'] . ' ' . $p['version'] . ' — ' . $p['name'] . "\n";
    }
    exit(0);

  case 'plugin:enable':
    $id = $argv[2] ?? '';
    if (!$id) { echo "Usage: php cli/cajeer plugin:enable <id>\n"; exit(2); }
    $pm = new \Plugins\PluginManager(ROOT_PATH . '/plugins', ROOT_PATH . '/system/plugins.php', trim(file_get_contents(ROOT_PATH . '/system/version.txt')));
    $pm->enable($id);
    echo "Enabled: $id\n";
    exit(0);

  case 'plugin:disable':
    $id = $argv[2] ?? '';
    if (!$id) { echo "Usage: php cli/cajeer plugin:disable <id>\n"; exit(2); }
    $pm = new \Plugins\PluginManager(ROOT_PATH . '/plugins', ROOT_PATH . '/system/plugins.php', trim(file_get_contents(ROOT_PATH . '/system/version.txt')));
    $pm->disable($id);
    echo "Disabled: $id\n";
    exit(0);

  case 'plugin:install':
    $id = $argv[2] ?? '';
    if (!$id) { echo "Usage: php cli/cajeer plugin:install <id>\n"; exit(2); }
    $pm = new \Plugins\PluginManager(ROOT_PATH . '/plugins', ROOT_PATH . '/system/plugins.php', trim(file_get_contents(ROOT_PATH . '/system/version.txt')));
    $pm->install($id);
    echo "Installed: $id\n";
    exit(0);

  case 'plugin:uninstall':
    $id = $argv[2] ?? '';
    if (!$id) { echo "Usage: php cli/cajeer plugin:uninstall <id>\n"; exit(2); }
    $pm = new \Plugins\PluginManager(ROOT_PATH . '/plugins', ROOT_PATH . '/system/plugins.php', trim(file_get_contents(ROOT_PATH . '/system/version.txt')));
    $pm->uninstall($id);
    echo "Uninstalled: $id\n";
    exit(0);



  case 'migrate:dle:check':
    \Core\Config::load();
    $cfg = require ROOT_PATH . '/system/dle.php';
    $tpl = $argv[2] ?? null;
    $m = new \Migration\Dle\DleMigrator();
    $report = $m->check($cfg, $tpl);
    $file = $report->save(ROOT_PATH . '/storage/migrations');
    echo "Report: $file\n";
    echo $report->ok() ? "OK\n" : "HAS ERRORS\n";
    exit($report->ok() ? 0 : 1);

  case 'migrate:dle:db':
    \Core\Config::load();
    $cfg = require ROOT_PATH . '/system/dle.php';
    $m = new \Migration\Dle\DleMigrator();
    $report = new \Migration\Report();
    try { $m->importDb($cfg, $report); } catch (\Throwable $e) { $report->error('Импорт БД упал', ['error'=>$e->getMessage()]); }
    $file = $report->save(ROOT_PATH . '/storage/migrations');
    echo "Report: $file\n";
    exit($report->ok() ? 0 : 1);

  case 'migrate:dle:templates':
    $src = $argv[2] ?? '';
    $dst = $argv[3] ?? (ROOT_PATH . '/templates/dle-converted');
    if (!$src) { echo "Usage: php cli/cajeer migrate:dle:templates <dle_templates_dir> [dst_dir]\n"; exit(2); }
    $report = new \Migration\Report();
    (new \Migration\Dle\DleMigrator())->convertTemplates($src, $dst, $report);
    $file = $report->save(ROOT_PATH . '/storage/migrations');
    echo "Converted -> $dst\n";
    echo "Report: $file\n";
    exit($report->ok() ? 0 : 1);

  case 'migrate:dle:run':
    \Core\Config::load();
    $cfg = require ROOT_PATH . '/system/dle.php';
    $srcTpl = $argv[2] ?? '';
    $dstTpl = $argv[3] ?? (ROOT_PATH . '/templates/dle-converted');
    if (!$srcTpl) { echo "Usage: php cli/cajeer migrate:dle:run <dle_templates_dir> [dst_dir]\n"; exit(2); }

    $m = new \Migration\Dle\DleMigrator();
    $report = $m->check($cfg, $srcTpl);
    if (!$report->ok()) {
      $file = $report->save(ROOT_PATH . '/storage/migrations');
      echo "Report: $file\n";
      echo "Compatibility check failed. Fix warnings/errors and retry.\n";
      exit(1);
    }
    try { $m->importDb($cfg, $report); } catch (\Throwable $e) { $report->error('Импорт БД упал', ['error'=>$e->getMessage()]); }
    $m->convertTemplates($srcTpl, $dstTpl, $report);

    $file = $report->save(ROOT_PATH . '/storage/migrations');
    echo "Report: $file\n";
    exit($report->ok() ? 0 : 1);


  case 'updater:check':
    \Core\Config::load();
    $u = new \Updater\Updater();
    $items = $u->check();
    echo "Channel: " . $u->channel() . "\n";
    foreach ($items as $it) {
      echo ($it['version'] ?? '0.0.0') . " — " . ($it['title'] ?? '') . " (" . ($it['file'] ?? '') . ")\n";
    }
    exit(0);

  case 'updater:backup':
    \Core\Config::load();
    $label = $argv[2] ?? 'manual';
    $u = new \Updater\Updater();
    $file = $u->backup($label);
    echo "Backup: $file\n";
    exit(0);

  case 'updater:restore':
    \Core\Config::load();
    $file = $argv[2] ?? '';
    if (!$file) { echo "Usage: php cli/cajeer updater:restore <backup_zip>\n"; exit(2); }
    (new \Updater\Updater())->restore($file);
    echo "Restored\n";
    exit(0);

  case 'updater:apply':
    \Core\Config::load();
    $pkg = $argv[2] ?? '';
    if (!$pkg) { echo "Usage: php cli/cajeer updater:apply <package.cajeerpkg|package.cajeerpatch>\n"; exit(2); }
    $u = new \Updater\Updater();
    $res = $u->apply($pkg);
    echo "Applied: " . ($res['id'] ?? '') . "\n";
    echo "Applied marker: " . ($res['applied_file'] ?? '') . "\n";
    echo "Backup: " . ($res['backup'] ?? '') . "\n";
    exit(0);


  case 'make:module':
    $name = $argv[2] ?? '';
    if (!$name) { echo "Usage: php cli/cajeer make:module <Name>\n"; exit(2); }
    (new \Dev\Scaffold\MakeModule())->run($name);
    echo "Module created: $name\n";
    exit(0);

  case 'make:content':
    $type = $argv[2] ?? '';
    if (!$type) { echo "Usage: php cli/cajeer make:content <type>\n"; exit(2); }
    (new \Dev\Scaffold\MakeContent())->run($type);
    echo "Content scaffold created: $type\n";
    exit(0);

  case 'make:template':
    $file = $argv[2] ?? '';
    if (!$file) { echo "Usage: php cli/cajeer make:template <file.tpl>\n"; exit(2); }
    (new \Dev\Scaffold\MakeTemplate())->run($file);
    echo "Template created: $file\n";
    exit(0);



  case 'theme:list':
    \Core\Config::load();
    $themes = \Theme\ThemeManager::list();
    echo "Active: " . \Theme\ThemeManager::active() . "\n";
    foreach ($themes as $k=>$v) echo $k . " — " . ($v['title'] ?? '') . "\n";
    exit(0);

  case 'theme:switch':
    \Core\Config::load();
    $theme = $argv[2] ?? '';
    if (!$theme) { echo "Usage: php cli/cajeer theme:switch <theme>\n"; exit(2); }
    $ok = \Theme\ThemeManager::switch($theme);
    echo $ok ? "OK\n" : "FAILED\n";
    exit($ok ? 0 : 1);

  case 'marketplace:status':
    \Core\Config::load();
    $c = new \Marketplace\Client();
    echo json_encode($c->status(), JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT) . "\n";
    exit(0);


  case 'site:list':
    \Core\Config::load();
    $cfg = is_file(ROOT_PATH . '/system/sites.php') ? (array)require ROOT_PATH . '/system/sites.php' : [];
    echo json_encode($cfg, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT) . "\n";
    exit(0);

  case 'api:token:add':
    $token = $argv[2] ?? '';
    $name = $argv[3] ?? 'token';
    if (!$token) { echo "Usage: php cli/cajeer api:token:add <token> [name]\n"; exit(2); }
    $cfgFile = ROOT_PATH . '/system/api.php';
    $cfg = is_file($cfgFile) ? (array)require $cfgFile : ['enabled'=>true,'tokens'=>[]];
    $cfg['tokens'][$token] = ['name'=>$name,'scopes'=>['read','write']];
    file_put_contents($cfgFile, "<?php\nreturn " . var_export($cfg, true) . ";\n");
    echo "Token added.\n";
    exit(0);

  default:
        echo "CajeerEngine CLI\n";
        echo "Commands:\n";
        echo "  diagnose\n";
        echo "  cache:clear\n";
        exit(0);
}
