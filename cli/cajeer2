#!/usr/bin/env php
<?php
require_once __DIR__ . '/../engine/bootstrap.php';

$cmd = $argv[1] ?? 'help';
function out($s){ echo $s . "\n"; }

if ($cmd === 'help') {
  out("CajeerEngine Platform CLI v2");
  out("Commands:");
  out("  plugins:sync                 Discover and sync plugins registry");
  out("  plugins:enable <slug>        Enable plugin (loads provider)");
  out("  plugins:disable <slug>       Disable plugin");
  out("  jobs:work [queue] [max]      Run jobs worker (graceful shutdown)");
  out("  jobs:supervise [queue]       Simple supervisor loop (restarts worker)");
  out("  dlq:list [tenant]            List dead-letter jobs");
  out("  events:replay <event_id>     Replay persisted event (foundation)");
  out("  marketplace:search <q> [type]            Search packages
  marketplace:install <registry> <id>      Install package
  marketplace:update <registry> <id>       Update (reinstall) package
  marketplace:uninstall <type> <slug>      Uninstall package
  marketplace:rollback <type> <slug> <dir> Rollback from backup dir
  accesslog:verify [limit]     Verify immutable access log chain
  compliance:soc2 [from] [to]  Generate SOC2 foundation report
  audit:verify                 Verify immutable audit chain");
  exit(0);
}

$kernel = new \Core\Kernel();
$kernel->boot();

$cfg = require ROOT_PATH . '/system/config.php';
\Database\DB::connect($cfg['db']);

$qcfg = is_file(ROOT_PATH . '/system/queue.php') ? require ROOT_PATH . '/system/queue.php' : [];

if ($cmd === 'plugins:sync') {
  $pm = $kernel->get('plugins');
  if (!$pm) { out("Plugin manager not available"); exit(1); }
  out(json_encode($pm->syncRegistry((int)($_SERVER['CE_TENANT_ID'] ?? 0)), JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES));
  exit(0);
}
if ($cmd === 'plugins:enable') {
  $slug = $argv[2] ?? '';
  if ($slug === '') { out("Usage: plugins:enable <slug>"); exit(1); }
  $pm = $kernel->get('plugins'); if(!$pm){ out("Plugin manager not available"); exit(1); }
  out(json_encode($pm->enable($slug, (int)($_SERVER['CE_TENANT_ID'] ?? 0)), JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES));
  exit(0);
}
if ($cmd === 'plugins:disable') {
  $slug = $argv[2] ?? '';
  if ($slug === '') { out("Usage: plugins:disable <slug>"); exit(1); }
  $pm = $kernel->get('plugins'); if(!$pm){ out("Plugin manager not available"); exit(1); }
  out(json_encode($pm->disable($slug, (int)($_SERVER['CE_TENANT_ID'] ?? 0)), JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES));
  exit(0);
}

if ($cmd === 'jobs:work') {
  $queue = $argv[2] ?? ($qcfg['default_queue'] ?? 'default');
  $max = (int)($argv[3] ?? 0);
  $worker = new \Core\Jobs\Worker($kernel->jobs(), $qcfg);
  $worker->work($queue, $max);
  exit(0);
}

if ($cmd === 'jobs:supervise') {
  $queue = $argv[2] ?? ($qcfg['default_queue'] ?? 'default');
  out("Supervisor started for queue: " . $queue);
  while (true) {
    $cmdline = PHP_BINARY . " " . escapeshellarg(__FILE__) . " jobs:work " . escapeshellarg($queue);
    passthru($cmdline);
    out("Worker exited. Restarting in 1s...");
    sleep(1);
  }
}

if ($cmd === 'dlq:list') {
  $tenant = (int)($argv[2] ?? 0);
  $pdo = \Database\DB::pdo();
  $sql = "SELECT id,job_id,tenant_id,queue,handler,attempts,failed_at FROM ce_job_failures";
  if ($tenant>0) $sql .= " WHERE tenant_id=".(int)$tenant;
  $sql .= " ORDER BY id DESC LIMIT 100";
  $items = $pdo->query($sql)->fetchAll(\PDO::FETCH_ASSOC);
  out(json_encode(['ok'=>true,'items'=>$items], JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES));
  exit(0);
}

if ($cmd === 'events:replay') {
  $id = (int)($argv[2] ?? 0);
  if ($id<=0) { out("Usage: events:replay <event_id>"); exit(1); }
  $e = \Core\Events\EventStore::fetchById($id);
  if (!$e) { out("Event not found"); exit(1); }
  $sync = $kernel->get('events_sync');
  $sync->emit((string)$e['name'], (array)$e['payload']);
  out(json_encode(['ok'=>true,'replayed'=>$id,'name'=>$e['name']], JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES));
  exit(0);
}


if ($cmd === 'marketplace:search') {
  $q = $argv[2] ?? '';
  $type = $argv[3] ?? '';
  if ($q === '') { out("Usage: marketplace:search <q> [type]"); exit(1); }
  $mp = $kernel->get('marketplace');
  if (!$mp) { out("Marketplace not available"); exit(1); }
  out(json_encode($mp->search($q, $type), JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES));
  exit(0);
}
if ($cmd === 'marketplace:install') {
  $reg = $argv[2] ?? '';
  $id = $argv[3] ?? '';
  if ($reg==='' || $id==='') { out("Usage: marketplace:install <registry> <package_id>"); exit(1); }
  $mp = $kernel->get('marketplace');
  if (!$mp) { out("Marketplace not available"); exit(1); }
  out(json_encode($mp->install($reg, $id, (int)($_SERVER['CE_TENANT_ID'] ?? 0)), JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES));
  exit(0);
}
if ($cmd === 'marketplace:update') {
  $reg = $argv[2] ?? '';
  $id = $argv[3] ?? '';
  if ($reg==='' || $id==='') { out("Usage: marketplace:update <registry> <package_id>"); exit(1); }
  $mp = $kernel->get('marketplace');
  if (!$mp) { out("Marketplace not available"); exit(1); }
  out(json_encode($mp->update($reg, $id, (int)($_SERVER['CE_TENANT_ID'] ?? 0)), JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES));
  exit(0);
}
if ($cmd === 'marketplace:uninstall') {
  $type = $argv[2] ?? '';
  $slug = $argv[3] ?? '';
  if ($type==='' || $slug==='') { out("Usage: marketplace:uninstall <type> <slug>"); exit(1); }
  $mp = $kernel->get('marketplace');
  if (!$mp) { out("Marketplace not available"); exit(1); }
  out(json_encode($mp->uninstall($type, $slug, (int)($_SERVER['CE_TENANT_ID'] ?? 0)), JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES));
  exit(0);
}
if ($cmd === 'marketplace:rollback') {
  $type = $argv[2] ?? '';
  $slug = $argv[3] ?? '';
  $dir = $argv[4] ?? '';
  if ($type==='' || $slug==='' || $dir==='') { out("Usage: marketplace:rollback <type> <slug> <backup_dir>"); exit(1); }
  $mp = $kernel->get('marketplace');
  if (!$mp) { out("Marketplace not available"); exit(1); }
  out(json_encode($mp->rollback($type, $slug, $dir, (int)($_SERVER['CE_TENANT_ID'] ?? 0)), JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES));
  exit(0);
}


if ($cmd === 'accesslog:verify') {
  $limit = (int)($argv[2] ?? 10000);
  out(json_encode(\Security\AccessLog::verifyChain($limit), JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES));
  exit(0);
}
if ($cmd === 'compliance:soc2') {
  $from = $argv[2] ?? null;
  $to = $argv[3] ?? null;
  $tenant = (int)($_SERVER['CE_TENANT_ID'] ?? 0);
  out(json_encode(\Security\Compliance::generateSOC2($tenant, $from, $to), JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES));
  exit(0);
}

if ($cmd === 'audit:verify') {
  out(json_encode(\Security\AuditTrail::verifyChain(5000), JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES));
  exit(0);
}

out("Unknown command. Use: help");
exit(1);
